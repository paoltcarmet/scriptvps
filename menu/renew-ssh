#!/bin/bash
clear
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "\E[0;41;36m        RENEW SSH ACCOUNT          \E[0m"
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"

# Menampilkan list akun aktif
printf "\n%-20s %-20s\n" "Username" "Expired"
echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
getent passwd | while IFS=: read -r user _ uid gid _ home shell; do
  if [[ "$uid" -ge 1000 && "$shell" == "/bin/false" ]]; then
    exp=$(chage -l "$user" | grep "Account expires" | awk -F": " '{print $2}')
    printf "%-20s %-20s\n" "$user" "$exp"
  fi
done
echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

read -p "Username               : " username
read -p "Tambah masa aktif (hari): " tambah

# Validasi user
if ! id "$username" &>/dev/null; then
  echo -e "\n\033[0;31m❌ Username '$username' tidak ditemukan!\033[0m"
  exit 1
fi

# Hitung tanggal expired baru
old_exp=$(chage -l "$username" | grep "Account expires" | awk -F": " '{print $2}')
old_epoch=$(date -d "$old_exp" +%s 2>/dev/null || echo 0)
now_epoch=$(date +%s)

if [[ "$old_epoch" -lt "$now_epoch" ]]; then
  base_date=$(date +%Y-%m-%d)
else
  base_date=$(date -d "$old_exp" +%Y-%m-%d)
fi

new_exp=$(date -d "$base_date +$tambah days" +"%Y-%m-%d")
new_exp_full=$(date -d "$base_date +$tambah days" +"%Y-%m-%d-%H-%M-%S")

# Perpanjang user
chage -E "$new_exp" "$username"

# Simpan expired ke file
mkdir -p /etc/v2ray/ssh/expired
echo "$new_exp_full" > /etc/v2ray/ssh/expired/${username}.exp

# Ambil data tambahan
dmsa=$(cat /etc/v2ray/domain)

# Ambil token & id
BOT_TOKEN=$(cat /etc/v2ray/bot/token.txt)
CHAT_ID=$(cat /etc/v2ray/bot/id.txt)

# Format pesan Telegram
TEXT="<b>━━━━━━━━━━━━━━━━━━━━━━━━</b>%0A"
TEXT+="<b>     SSH RENEWED ⚡️     </b>%0A"
TEXT+="<b>━━━━━━━━━━━━━━━━━━━━━━━━</b>%0A"
TEXT+="<b>Hostname  :</b> $dmsa%0A"
TEXT+="<b>Username  :</b> $username%0A"
TEXT+="<b>Expired   :</b> $new_exp%0A"
TEXT+="<b>━━━━━━━━━━━━━━━━━━━━━━━━</b>%0A"
TEXT+="<b>HTTP  | NTLS :</b> 80%0A"
TEXT+="<b>HTTPS | SSL  :</b> 443%0A"
TEXT+="<b>SSL   | TLS  :</b> 443%0A"
TEXT+="<b>OpenSSH      :</b> 109%0A"
TEXT+="<b>UdpGW/Badvpn :</b> 7300%0A"
TEXT+="<b>Udp Custom   :</b> 1-65535%0A"
TEXT+="<b>━━━━━━━━━━━━━━━━━━━━━━━━</b>%0A"
TEXT+="<b>Payload WS HTTP :</b>%0A<code>GET / HTTP/1.1[crlf]Host: [host][crlf]Upgrade: websocket[crlf][crlf]</code>%0A"
TEXT+="<b>━━━━━━━━━━━━━━━━━━━━━━━━</b>"

# Kirim notifikasi
curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
  -d chat_id="$CHAT_ID" \
  -d parse_mode="HTML" \
  -d text="$TEXT" > /dev/null

# Tampilkan di terminal
clear
echo -e "
\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m
\033[1;33m         SSH RENEWED ⚡️           \033[0m
\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m
Hostname        : $dmsa
Username        : $username
Expired         : $new_exp
\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m
HTTP  | NTLS    : 80
HTTPS | SSL     : 443
SSL   | TLS     : 443
OpenSSH         : 109
UdpGW/Badvpn    : 7300
Udp Custom      : 1-65535
\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m
Payload WS HTTP:
GET / HTTP/1.1[crlf]Host: [host][crlf]Upgrade: websocket[crlf][crlf]
\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m
"