#!/bin/bash
clear
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "\E[0;41;36m          TRIAL SSH ACCOUNT         \E[0m"
echo -e "\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"

# Generate random username dan password
Login="trial-$(tr -dc X-Z0-9 </dev/urandom | head -c4)"
Pass=$(tr -dc a-k0-9 </dev/urandom | head -c6)

# Input waktu
read -p "Expired (ex: 1m / 30m / 2h / 1d): " durasi

# Konversi ke detik
case "$durasi" in
  *m) seconds=$(( ${durasi%m} * 60 )) ;;
  *h) seconds=$(( ${durasi%h} * 3600 )) ;;
  *d) seconds=$(( ${durasi%d} * 86400 )) ;;
  *) echo "❌ Format tidak valid (gunakan: 30m, 2h, 1d)"; exit 1 ;;
esac

# Buat akun
useradd -e $(date -d "+$seconds seconds" +"%Y-%m-%d") -s /bin/false -M $Login
echo -e "$Pass\n$Pass\n" | passwd $Login &> /dev/null

# Format expired
exp_date=$(date -d "+$seconds seconds" +"%Y-%m-%d")
exp_full=$(date -d "+$seconds seconds" +"%Y-%m-%d-%H-%M-%S")

# Simpan file expired
mkdir -p /etc/v2ray/ssh/expired
echo "$exp_full" > /etc/v2ray/ssh/expired/${Login}.exp

# Ambil data sistem
dmsa=$(cat /etc/v2ray/domain)

# Notifikasi Telegram
BOT_TOKEN=$(cat /etc/v2ray/bot/token.txt)
CHAT_ID=$(cat /etc/v2ray/bot/id.txt)

TEXT="<b>━━━━━━━━━━━━━━━━━━━━━━━━</b>%0A"
TEXT+="<b>    TRIAL SSH ACCOUNT    </b>%0A"
TEXT+="<b>━━━━━━━━━━━━━━━━━━━━━━━━</b>%0A"
TEXT+="<b>Hostname :</b> $dmsa%0A"
TEXT+="<b>Username :</b> $Login%0A"
TEXT+="<b>Password :</b> $Pass%0A"
TEXT+="<b>Expired  :</b> $exp_date%0A"
TEXT+="<b>━━━━━━━━━━━━━━━━━━━━━━━━</b>%0A"
TEXT+="<b>HTTP  | NTLS :</b> 80%0A"
TEXT+="<b>HTTPS | SSL  :</b> 443%0A"
TEXT+="<b>SSL   | TLS  :</b> 443%0A"
TEXT+="<b>OpenSSH      :</b> 109%0A"
TEXT+="<b>UdpGW/Badvpn :</b> 7300%0A"
TEXT+="<b>Udp Custom   :</b> 1-65535%0A"
TEXT+="<b>━━━━━━━━━━━━━━━━━━━━━━━━</b>%0A"
TEXT+="<b>Payload WS HTTP :</b>%0A<code>GET / HTTP/1.1[crlf]Host: [host][crlf]Upgrade: websocket[crlf][crlf]</code>%0A"
TEXT+="<b>━━━━━━━━━━━━━━━━━━━━━━━━</b>"

curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
  -d chat_id="$CHAT_ID" \
  -d parse_mode="HTML" \
  -d text="$TEXT" > /dev/null

# Tampilkan hasil
clear
echo -e "
\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m
\033[1;32m         TRIAL SSH ACCOUNT         \033[0m
\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m
Hostname        : $dmsa
Username        : $Login
Password        : $Pass
Expired         : $exp_date
\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m
HTTP  | NTLS    : 80
HTTPS | SSL     : 443
SSL   | TLS     : 443
OpenSSH         : 109
UdpGW/Badvpn    : 7300
Udp Custom      : 1-65535
\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m
Payload WS HTTP:
GET / HTTP/1.1[crlf]Host: [host][crlf]Upgrade: websocket[crlf][crlf]
\033[0;34m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m
"